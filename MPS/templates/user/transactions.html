{% extends 'user/userhome.html' %}
{% load static %}

{% block title %}
    Transaction History
{% endblock %}

{% block content %}
{% if user.is_authenticated and not user.is_superuser and not user.is_staff %}

<a href="javascript:history.back()"><span class="go-back fas fa-chevron-left">Go Back</span></a>
<h2 class="page-header text-justified">Transaction History</h2>

<form class="form-group" method="post">
    {% csrf_token %}
    <table data-toggle="table" data-pagination="true" class="table table-bordered">
        <thead class="thead-dark">
            <tr>
                <th>Name</th>
                <th>Card No.</th>
                <th>Bank Name</th>
                <th>Amount</th>
                <th>Transaction</th>
                <th>Time</th>
                <th>Status</th>
                <th>Receipt</th>  <!-- New column for download button -->
            </tr>
        </thead>
        <tbody id="myTable">
        {% for txn in txns %}
            {% if user.username == txn.to_account or user.username == txn.from_account %}
            <tr>
                <td>{{ txn.name }}</td>
                <td>{{ txn.card }}</td>
                <td>{{ txn.bank }}</td>

                {% if txn.from_account == txn.to_account %}
                    {% if txn.txntype == 'Deposit' %}
                        <td><div style="color: green;">+{{ txn.amount }}</div></td>
                        <td><div style="color: green;">{{ txn.txntype }}</div></td>
                    {% elif txn.txntype == 'Withdraw' %}
                        <td><div style="color: red;">-{{ txn.amount }}</div></td>
                        <td><div style="color: red;">{{ txn.txntype }}</div></td>
                    {% endif %}
                {% else %}
                    {% if user.username == txn.to_account %}
                        <td><div style="color: green;">+{{ txn.amount }}</div></td>
                        <td><div style="color: green;">From {{ txn.from_account }}</div></td>
                    {% elif user.username == txn.from_account %}
                        <td><div style="color: red;">-{{ txn.amount }}</div></td>
                        <td><div style="color: red;">To {{ txn.to_account }}</div></td>
                    {% endif %}
                {% endif %}

                <td>{{ txn.time }}</td>
                <td>
                    {% if txn.txnstatus %}
                        <div style="color: green;"><i class="fa fa-check"></i> Completed</div>
                    {% else %}
                        <i class="fa fa-spinner"></i> Pending
                    {% endif %}
                </td>
                <td>
                    <a href="{% url 'download_receipt' txn.id %}" class="btn btn-sm btn-primary">Download Receipt</a>
                </td>
            </tr>
            {% endif %}
        {% endfor %}
        </tbody>
    </table>
</form>

{% else %}
    <meta http-equiv="refresh" content="0; url={% url 'home' %}">
{% endif %}
{% endblock %}

